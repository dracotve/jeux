<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Jeu Pixel Art - L'Énigme</title>
    <style>
        body {
            margin: 0;
            background: black;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            color: white;
            font-family: 'Courier New', Courier, monospace;
        }

        canvas {
            border: 2px solid white;
            image-rendering: pixelated;
            cursor: crosshair;
        }

        #story-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: black;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
            z-index: 10;
        }

        .fade-in {
            animation: fadeIn 2s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body>

<div id="story-overlay">
    <p id="story-text"></p>
</div>

<canvas id="game" width="800" height="450"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const overlay = document.getElementById("story-overlay");
const storyText = document.getElementById("story-text");

// === CONFIGURATION ===
const limiteHaut = 305; 
const limiteBas = 370;
let cameraX = 0;
const DISTANCE_ARBRE = 1000; 
let gameEnded = false;

// === IMAGES ===
const background = new Image();
background.src = "https://i.imgur.com/1iPHzZk.png";
const playerIdle = new Image();
playerIdle.src = "https://i.imgur.com/SvsfsiA.png";
const playerWalk = new Image();
playerWalk.src = "https://i.imgur.com/0eb0KYR.png";
const carImg = new Image();
carImg.src = "https://i.imgur.com/y7EmwQ0.png";
const propImg = new Image();
propImg.src = "https://i.imgur.com/V30Jbyq.png";
const bushImg = new Image();
bushImg.src = "https://i.imgur.com/krm21gr.png";

// === VARIABLES D'ÉTAT ===
let player = {
    x: 150,
    y: 370,
    targetX: 150,
    targetY: 370,
    speed: 2.5,
    moving: false,
    inCar: false
};

let car = {
    x: 500,
    y: 260,
    width: 124,
    height: 134,
    speed: 6
};

// === GESTION DE L'ÉVÉNEMENT 1000M ===
function triggerEnding() {
    gameEnded = true;
    overlay.style.display = "flex";
    
    // Premier texte
    storyText.innerText = "You open the glove box and find a paper and you decide to read it.......";
    storyText.classList.add("fade-in");

    // Après 5 secondes, afficher l'énigme
    setTimeout(() => {
        storyText.style.opacity = 0;
        setTimeout(() => {
            storyText.innerText = "Look like water attraction, you can see trees on this place, this place is more bigger than Boca Grande.\n\nThere is a beautiful view when you are in the water attraction. You can see animals like bird and fishes. On the water they are waterlillies.\n\nCan you find me? Where I am ?";
            storyText.style.opacity = 1;
            storyText.classList.add("fade-in");
        }, 1000);
    }, 5000);
}

// === CLIC SOURIS ===
canvas.addEventListener("click", (e) => {
    if (gameEnded) return;
    const rect = canvas.getBoundingClientRect();
    const clickX = e.clientX - rect.left + cameraX;
    let clickY = e.clientY - rect.top;

    if (clickY < limiteHaut) clickY = limiteHaut;
    if (clickY > limiteBas) clickY = limiteBas;

    const clickedOnCar = (clickX > car.x && clickX < car.x + car.width && clickY > car.y && clickY < car.y + car.height);

    if (clickedOnCar) {
        if (!player.inCar) {
            player.targetX = car.x + car.width / 2;
            player.targetY = car.y + car.height / 2;
            player.moving = true;
        } else {
            player.inCar = false;
            player.x = car.x - 40;
            player.y = limiteBas;
            player.targetX = player.x;
            player.targetY = player.y;
        }
    } else {
        player.targetX = clickX;
        player.targetY = clickY;
        player.moving = true;
    }
});

function update() {
    if (gameEnded) return;

    if (!player.inCar) {
        const dx = player.targetX - player.x;
        const dy = player.targetY - player.y;
        const dist = Math.sqrt(dx*dx + dy*dy);
        if (dist > 2) {
            player.x += (dx/dist) * player.speed;
            player.y += (dy/dist) * player.speed;
            player.moving = true;
        } else {
            player.moving = false;
            if (Math.abs(player.x - (car.x + car.width/2)) < 15) player.inCar = true;
        }
    } else {
        const tx = player.targetX - car.width/2;
        const ty = player.targetY - car.height/2;
        const dx = tx - car.x;
        const dy = ty - car.y;
        const dist = Math.sqrt(dx*dx + dy*dy);
        if (dist > 5) {
            car.x += (dx/dist) * car.speed;
            car.y += (dy/dist) * car.speed;
        }
        player.x = car.x + car.width/2;
        player.y = car.y + car.height / 2;
    }

    let targetCamX = player.x - 400;
    cameraX += (targetCamX - cameraX) * 0.1;

    // VERIFICATION DE LA DISTANCE (1000m)
    // On divise x par 20 pour correspondre à l'affichage de l'UI
    if (player.x / 20 >= 1000) {
        triggerEnding();
    }
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.save();
    ctx.translate(-cameraX, 0);

    const bgWidth = canvas.width; 
    let startBG = Math.floor(cameraX / bgWidth) * bgWidth;
    for (let i = -1; i <= 2; i++) {
        ctx.drawImage(background, startBG + (i * bgWidth), 0, bgWidth, canvas.height);
    }

    ctx.drawImage(propImg, 430, 242, 64, 128); 

    let premierVisible = Math.floor((cameraX - 200) / DISTANCE_ARBRE);
    let dernierVisible = Math.ceil((cameraX + 1000) / DISTANCE_ARBRE);
    for (let j = premierVisible; j <= dernierVisible; j++) {
        let treeX = j * DISTANCE_ARBRE;
        if (treeX !== 0) ctx.drawImage(bushImg, treeX, 250, 120, 120);
    }

    ctx.drawImage(carImg, car.x, car.y, car.width, car.height);

    if (!player.inCar) {
        const img = player.moving ? playerWalk : playerIdle;
        ctx.drawImage(img, player.x - 16, player.y - 16, 32, 32);
    }

    ctx.restore();

    // UI
    ctx.fillStyle = "rgba(0, 0, 0, 0.7)";
    ctx.fillRect(10, 10, 200, 30);
    ctx.fillStyle = "white";
    ctx.font = "bold 14px Arial";
    ctx.fillText(`Distance : ${Math.floor(player.x / 20)} m`, 20, 30);
}

function gameLoop() {
    update();
    draw();
    requestAnimationFrame(gameLoop);
}

background.onload = () => gameLoop();
</script>
</body>
</html>